INSERT OVERWRITE TABLE shipment_facility_l2_90_fact
select 
D.vendor_tracking_id,
D.incoming_consignment_id,
D.incoming_bag_id,
D.incoming_consignment_system_weight,
D.incoming_consignment_connection_id,
D.incoming_consignment_type,
D.incoming_consignment_mode,
D.incoming_connection_type,
D.incoming_connection_transit_type,
D.incoming_connection_code,
D.incoming_connection_frequency_type,
D.incoming_consignment_status,
D.incoming_consignment_co_loader,
D.incoming_consignment_breach_flag,
D.incoming_consignment_movement_flag,
D.incoming_consignment_no_of_bags,
D.incoming_consignment_no_of_shipments,
D.incoming_consignment_tms_compliant_flag,
D.incoming_consignment_creation_delay_in_hours,
D.incoming_consignment_source_hub_type,
D.incoming_consignment_destination_hub_type,
D.incoming_consignment_source_hub_id ,
D.incoming_consignment_destination_hub_id,
D.incoming_consignment_source_hub_id_key,
D.incoming_consignment_destination_hub_id_key,
D.incoming_connection_cut_off_datetime,
D.incoming_consignment_create_datetime,
D.incoming_consignment_create_unixseconds,
D.incoming_consignment_status_date_time,
D.incoming_consignment_eta_datetime,
D.incoming_consignment_received_datetime,
D.incoming_bag_tracking_id,
D.incoming_bag_service_type,
D.incoming_bag_seal_id,
D.incoming_bag_current_status,
D.incoming_bag_category,
D.incoming_bag_no_of_shipments,
D.incoming_bag_eta_update_reason,
D.incoming_bag_system_weight,
D.incoming_bag_source_hub_id,
D.incoming_bag_current_hub_id,
D.incoming_bag_destination_hub_id,
D.incoming_bag_source_hub_id_key,
D.incoming_bag_current_hub_id_key,
D.incoming_bag_destination_hub_id_key,
D.incoming_bag_created_hub_type,
D.incoming_bag_current_hub_type,
D.incoming_bag_destination_hub_type,
D.incoming_bag_created_at_datetime,
D.incoming_bag_open_datetime,
D.incoming_bag_closed_datetime,
D.incoming_bag_connected_datetime,
D.incoming_bag_destination_hub_inscan_datetime,
D.incoming_bag_receive_datetime,
D.incoming_bag_last_update_datetime,
D.incoming_hop_source_type,
D.outgoing_consignment_id,
D.outgoing_bag_id,
D.outgoing_consignment_system_weight,
D.outgoing_consignment_connection_id,
D.outgoing_consignment_type,
D.outgoing_consignment_mode,
D.outgoing_connection_type,
D.outgoing_connection_transit_type,
D.outgoing_connection_code,
D.outgoing_connection_frequency_type,
D.outgoing_consignment_status,
D.outgoing_consignment_co_loader,
D.outgoing_consignment_breach_flag,
D.outgoing_consignment_movement_flag,
D.outgoing_consignment_no_of_bags,
D.outgoing_consignment_no_of_shipments,
D.outgoing_consignment_tms_compliant_flag,
D.outgoing_consignment_creation_delay_in_hours,
D.outgoing_consignment_source_hub_type,
D.outgoing_consignment_destination_hub_type,
D.outgoing_consignment_source_hub_id ,
D.outgoing_consignment_destination_hub_id, 
D.outgoing_consignment_source_hub_id_key,
D.outgoing_consignment_destination_hub_id_key,
D.outgoing_connection_cut_off_datetime,
D.outgoing_consignment_create_datetime,
D.outgoing_consignment_create_unixseconds,
D.outgoing_consignment_status_date_time,
D.outgoing_consignment_eta_datetime,
D.outgoing_consignment_received_datetime,
D.outgoing_bag_tracking_id,
D.outgoing_bag_service_type,
D.outgoing_bag_seal_id,
D.outgoing_bag_current_status,
D.outgoing_bag_category,
D.outgoing_bag_no_of_shipments,
D.outgoing_bag_eta_update_reason,
D.outgoing_bag_system_weight,
D.outgoing_bag_source_hub_id,
D.outgoing_bag_current_hub_id,
D.outgoing_bag_destination_hub_id,
D.outgoing_bag_source_hub_id_key,
D.outgoing_bag_current_hub_id_key,
D.outgoing_bag_destination_hub_id_key,
D.outgoing_bag_created_hub_type,
D.outgoing_bag_current_hub_type,
D.outgoing_bag_destination_hub_type,
D.outgoing_bag_created_at_datetime,
D.outgoing_bag_open_datetime,
D.outgoing_bag_closed_datetime,
D.outgoing_bag_connected_datetime,
D.outgoing_bag_destination_hub_inscan_datetime,
D.outgoing_bag_receive_datetime,
D.outgoing_bag_last_update_datetime,
D.outgoing_hop_source_type,
D.shipment_id,
D.first_associated_shipment_id,
D.merchant_reference_id,
D.merchant_id,
D.seller_id,
D.shipment_current_status,
D.payment_type,
D.payment_mode,
D.amount_collected,
D.seller_type,
D.shipment_dg_flag,
D.shipment_fragile_flag,
D.shipment_priority_flag,
D.service_tier,
D.surface_mandatory_flag,
D.shipment_size_flag,
D.item_quantity,
D.shipping_category,
D.ekl_shipment_type,
D.reverse_shipment_type,
D.first_undelivery_status,
D.last_undelivery_status,
D.ekl_fin_zone,
D.ekart_lzn_flag,
D.shipment_fa_flag,
D.vendor_id,
D.shipment_carrier,
D.shipment_pending_flag,
D.shipment_num_of_pk_attempt,
D.fsd_number_of_ofd_attempts,
D.shipment_rvp_pk_number_of_attempts,
D.shipment_weight,
D.volumetric_weight_source,
D.volumetric_weight,
D.billable_weight,
D.billable_weight_type,
D.cost_of_breach,
D.shipment_value,
D.cod_amount_to_collect,
D.shipment_charge,
D.source_address_pincode,
D.destination_address_pincode,
D.customer_address_id,
D.cs_notes,
D.hub_notes,
D.fsd_assigned_hub_id,
D.reverse_pickup_hub_id,
D.shipment_current_hub_id,
D.shipment_first_received_hub_id,
D.shipment_last_received_hub_id,
D.shipment_first_received_mh_id,
D.shipment_last_received_mh_id,
D.shipment_origin_mh_facility_id,
D.shipment_destination_mh_facility_id,
D.shipment_origin_facility_id,
D.shipment_destination_facility_id,
D.shipment_first_received_dh_id,
D.shipment_last_received_dh_id,
D.shipment_first_received_pc_id,
D.shipment_last_received_pc_id,
D.rto_received_hub_id,
D.shipment_current_hub_type,
D.shipment_created_at_datetime,
D.shipment_dispatch_datetime,
D.vendor_dispatch_datetime,
D.shipment_current_status_datetime,
D.shipment_first_received_at_datetime,
D.shipment_delivered_at_datetime,
D.shipment_first_delivery_update_datetime,
D.shipment_last_delivery_update_datetime,
D.shipment_first_dispatched_to_merchant_datetime,
D.logistics_promise_datetime,
D.shipment_actual_sla_datetime,
D.customer_promise_datetime,
D.new_logistics_promise_datetime,
D.new_customer_promise_datetime,
D.shipment_last_receive_datetime,
D.fsd_first_dh_received_datetime,
D.fsd_last_dh_received_datetime,
D.shipment_first_received_pc_datetime,
D.shipment_last_received_pc_datetime,
D.fsd_first_ofd_datetime,
D.fsd_last_ofd_datetime,
D.shipment_first_rfp_datetime,
D.shipment_last_rfp_datetime,
D.shipment_first_rvp_pickup_time,
D.shipment_last_rvp_pickup_time,
D.received_at_origin_facility_datetime,
D.rto_first_received_datetime,
D.rto_create_datetime,
D.rto_complete_datetime,
D.tpl_first_ofd_datetime,
D.tpl_last_ofd_datetime,
D.first_mh_tc_receive_datetime,
D.last_mh_tc_receive_datetime,
D.first_mh_tc_outscan_datetime,
D.last_mh_tc_outscan_datetime,
D.first_dh_outscan_datetime,
D.last_dh_outscan_datetime,
D.profiled_hub_id,
D.profiler_flag,
D.shipment_direction_flag,
If(D.incoming_bag_destination_hub_inscan_datetime_0 is not null and unix_timestamp(D.incoming_bag_destination_hub_inscan_datetime_0) < unix_timestamp(D.incoming_consignment_create_datetime),
IF(unix_timestamp(D.incoming_bag_destination_hub_inscan_datetime_0) > unix_timestamp(cast(C.shipment_inscan as TIMESTAMP)),
cast(D.incoming_bag_destination_hub_inscan_datetime_0 as TIMESTAMP),
If(unix_timestamp(cast(C.shipment_inscan as TIMESTAMP)) < unix_timestamp(D.incoming_consignment_create_datetime),
if(D.incoming_consignment_source_hub_id_0=D.fsd_assigned_hub_id,cast(C.shipment_inscan_2 as timestamp),
cast(C.shipment_inscan as TIMESTAMP)),
cast(D.incoming_bag_destination_hub_inscan_datetime_0 as TIMESTAMP)
)
),
if(D.incoming_consignment_source_hub_id_0=D.fsd_assigned_hub_id,cast(C.shipment_inscan_2 as timestamp),
cast(C.shipment_inscan as TIMESTAMP))
) as shipment_facility_inscan_datetime,

If( unix_timestamp(coalesce(D.incoming_bag_destination_hub_inscan_datetime,D.incoming_bag_closed_datetime)) < unix_timestamp(D.outgoing_consignment_create_datetime),
IF(unix_timestamp(coalesce(D.incoming_bag_destination_hub_inscan_datetime,D.incoming_bag_closed_datetime)) > unix_timestamp(cast(E.shipment_inscan as TIMESTAMP)),
cast(coalesce(D.incoming_bag_destination_hub_inscan_datetime,D.incoming_bag_closed_datetime) as TIMESTAMP),
IF(unix_timestamp(cast(E.shipment_inscan as TIMESTAMP)) < unix_timestamp(D.outgoing_consignment_create_datetime) ,
if(D.incoming_consignment_source_hub_id=D.fsd_assigned_hub_id,cast(E.shipment_inscan_2 as timestamp),
cast(E.shipment_inscan as TIMESTAMP)),
cast(coalesce(D.incoming_bag_destination_hub_inscan_datetime,D.incoming_bag_closed_datetime) as TIMESTAMP)
)
)
,
if(D.incoming_consignment_source_hub_id=D.fsd_assigned_hub_id,cast(E.shipment_inscan_2 as timestamp),
cast(E.shipment_inscan as TIMESTAMP))
) as shipment_facility_outscan_datetime,
D.shipment_direction_flag_out,
D.incoming_bag_destination_hub_inscan_datetime_0 as incoming_bag_source_hub_receive_datetime,
D.incoming_consignment_source_hub_id_0 as incoming_consignment_source_hub_id_0,
D.incoming_consignment_source_hub_id_key_0 as incoming_consignment_source_hub_id_0_key,
D.incoming_consignment_create_datetime_0 as incoming_consignment_create_datetime_0,
D.incoming_consignment_received_datetime_0 as incoming_consignment_received_datetime_0,
case when preprimary_fac <> 0 and rank = 2 then 'SORT' 
when preprimary_fac = 0 and rank = 1 then 'SORT' 
when preprimary_fac <> 0 and rank = 1 then 'PREPRIMARY' else 'RESORT' end as sort_resort_new,
sr.preprimary_fac
from 
(   select 
T.incoming_bag_destination_hub_inscan_datetime as incoming_bag_destination_hub_inscan_datetime_0,
T.incoming_bag_id as incoming_bag_id_0 ,
T.incoming_consignment_source_hub_id as incoming_consignment_source_hub_id_0,
T.incoming_consignment_source_hub_id_key as incoming_consignment_source_hub_id_key_0,
T.incoming_consignment_create_datetime as incoming_consignment_create_datetime_0,
T.incoming_consignment_received_datetime as incoming_consignment_received_datetime_0,
A.vendor_tracking_id,
A.incoming_consignment_id,
A.incoming_bag_id,
A.incoming_consignment_system_weight,
A.incoming_consignment_connection_id,
A.incoming_consignment_type,
A.incoming_consignment_mode,
A.incoming_connection_type,
A.incoming_connection_transit_type,
A.incoming_connection_code,
A.incoming_connection_frequency_type,
A.incoming_consignment_status,
A.incoming_consignment_co_loader,
A.incoming_consignment_breach_flag,
A.incoming_consignment_movement_flag,
A.incoming_consignment_no_of_bags,
A.incoming_consignment_no_of_shipments,
A.incoming_consignment_tms_compliant_flag,
A.incoming_consignment_creation_delay_in_hours,
A.incoming_consignment_source_hub_type,
A.incoming_consignment_destination_hub_type,
A.incoming_consignment_source_hub_id ,
A.incoming_consignment_destination_hub_id,
A.incoming_consignment_source_hub_id_key,
A.incoming_consignment_destination_hub_id_key,
A.incoming_connection_cut_off_datetime,
A.incoming_consignment_create_datetime,
A.incoming_consignment_create_unixseconds,
A.incoming_consignment_status_date_time,
A.incoming_consignment_eta_datetime,
A.incoming_consignment_received_datetime,
A.incoming_bag_tracking_id,
A.incoming_bag_service_type,
A.incoming_bag_seal_id,
A.incoming_bag_current_status,
A.incoming_bag_category,
A.incoming_bag_no_of_shipments,
A.incoming_bag_eta_update_reason,
A.incoming_bag_system_weight,
A.incoming_bag_source_hub_id,
A.incoming_bag_current_hub_id,
A.incoming_bag_destination_hub_id,
A.incoming_bag_source_hub_id_key,
A.incoming_bag_current_hub_id_key,
A.incoming_bag_destination_hub_id_key,
A.incoming_bag_created_hub_type,
A.incoming_bag_current_hub_type,
A.incoming_bag_destination_hub_type,
A.incoming_bag_created_at_datetime,
A.incoming_bag_open_datetime,
A.incoming_bag_closed_datetime,
A.incoming_bag_connected_datetime,
A.incoming_bag_destination_hub_inscan_datetime,
A.incoming_bag_receive_datetime,
A.incoming_bag_last_update_datetime,
A.incoming_hop_source_type,
A.outgoing_consignment_id,
A.outgoing_bag_id,
A.outgoing_consignment_system_weight,
A.outgoing_consignment_connection_id,
A.outgoing_consignment_type,
A.outgoing_consignment_mode,
A.outgoing_connection_type,
A.outgoing_connection_transit_type,
A.outgoing_connection_code,
A.outgoing_connection_frequency_type,
A.outgoing_consignment_status,
A.outgoing_consignment_co_loader,
A.outgoing_consignment_breach_flag,
A.outgoing_consignment_movement_flag,
A.outgoing_consignment_no_of_bags,
A.outgoing_consignment_no_of_shipments,
A.outgoing_consignment_tms_compliant_flag,
A.outgoing_consignment_creation_delay_in_hours,
A.outgoing_consignment_source_hub_type,
A.outgoing_consignment_destination_hub_type,
A.outgoing_consignment_source_hub_id ,
A.outgoing_consignment_destination_hub_id, 
A.outgoing_consignment_source_hub_id_key,
A.outgoing_consignment_destination_hub_id_key,
A.outgoing_connection_cut_off_datetime,
A.outgoing_consignment_create_datetime,
A.outgoing_consignment_create_unixseconds,
A.outgoing_consignment_status_date_time,
A.outgoing_consignment_eta_datetime,
A.outgoing_consignment_received_datetime,
A.outgoing_bag_tracking_id,
A.outgoing_bag_service_type,
A.outgoing_bag_seal_id,
A.outgoing_bag_current_status,
A.outgoing_bag_category,
A.outgoing_bag_no_of_shipments,
A.outgoing_bag_eta_update_reason,
A.outgoing_bag_system_weight,
A.outgoing_bag_source_hub_id,
A.outgoing_bag_current_hub_id,
A.outgoing_bag_destination_hub_id,
A.outgoing_bag_source_hub_id_key,
A.outgoing_bag_current_hub_id_key,
A.outgoing_bag_destination_hub_id_key,
A.outgoing_bag_created_hub_type,
A.outgoing_bag_current_hub_type,
A.outgoing_bag_destination_hub_type,
A.outgoing_bag_created_at_datetime,
A.outgoing_bag_open_datetime,
A.outgoing_bag_closed_datetime,
A.outgoing_bag_connected_datetime,
A.outgoing_bag_destination_hub_inscan_datetime,
A.outgoing_bag_receive_datetime,
A.outgoing_bag_last_update_datetime,
A.outgoing_hop_source_type,
B.shipment_id,
B.first_associated_shipment_id,
B.merchant_reference_id,
B.merchant_id,
B.seller_id,
B.shipment_current_status,
B.payment_type,
B.payment_mode,
B.amount_collected,
B.seller_type,
B.shipment_dg_flag,
B.shipment_fragile_flag,
B.shipment_priority_flag,
B.service_tier,
B.surface_mandatory_flag,
B.shipment_size_flag,
B.item_quantity,
B.shipping_category,
B.ekl_shipment_type,
B.reverse_shipment_type,
B.first_undelivery_status,
B.last_undelivery_status,
B.ekl_fin_zone,
B.ekart_lzn_flag,
B.shipment_fa_flag,
B.vendor_id,
B.shipment_carrier,
B.shipment_pending_flag,
B.shipment_num_of_pk_attempt,
B.fsd_number_of_ofd_attempts,
B.shipment_rvp_pk_number_of_attempts,
B.shipment_weight,
B.volumetric_weight_source,
B.volumetric_weight,
B.billable_weight,
B.billable_weight_type,
B.cost_of_breach,
B.shipment_value,
B.cod_amount_to_collect,
B.shipment_charge,
B.source_address_pincode,
B.destination_address_pincode,
B.customer_address_id,
B.cs_notes,
B.hub_notes,
B.fsd_assigned_hub_id,
B.reverse_pickup_hub_id,
B.shipment_current_hub_id,
B.shipment_first_received_hub_id,
B.shipment_last_received_hub_id,
B.shipment_first_received_mh_id,
B.shipment_last_received_mh_id,
B.shipment_origin_mh_facility_id,
B.shipment_destination_mh_facility_id,
B.shipment_origin_facility_id,
B.shipment_destination_facility_id,
B.shipment_first_received_dh_id,
B.shipment_last_received_dh_id,
B.shipment_first_received_pc_id,
B.shipment_last_received_pc_id,
B.rto_received_hub_id,
B.shipment_current_hub_type,
B.shipment_created_at_datetime,
B.shipment_dispatch_datetime,
B.vendor_dispatch_datetime,
B.shipment_current_status_datetime,
B.shipment_first_received_at_datetime,
B.shipment_delivered_at_datetime,
B.shipment_first_delivery_update_datetime,
B.shipment_last_delivery_update_datetime,
B.shipment_first_dispatched_to_merchant_datetime,
B.logistics_promise_datetime,
B.shipment_actual_sla_datetime,
B.customer_promise_datetime,
B.new_logistics_promise_datetime,
B.new_customer_promise_datetime,
B.shipment_last_receive_datetime,
B.fsd_first_dh_received_datetime,
B.fsd_last_dh_received_datetime,
B.shipment_first_received_pc_datetime,
B.shipment_last_received_pc_datetime,
B.fsd_first_ofd_datetime,
B.fsd_last_ofd_datetime,
B.shipment_first_rfp_datetime,
B.shipment_last_rfp_datetime,
B.shipment_first_rvp_pickup_time,
B.shipment_last_rvp_pickup_time,
B.received_at_origin_facility_datetime,
B.rto_first_received_datetime,
B.rto_create_datetime,
B.rto_complete_datetime,
B.tpl_first_ofd_datetime,
B.tpl_last_ofd_datetime,
B.first_mh_tc_receive_datetime,
B.last_mh_tc_receive_datetime,
B.first_mh_tc_outscan_datetime,
B.last_mh_tc_outscan_datetime,
B.first_dh_outscan_datetime,
B.last_dh_outscan_datetime,
B.profiled_hub_id,
B.profiler_flag,
If(B.ekl_shipment_type like '%rto%' and B.rto_create_datetime > A.incoming_consignment_create_datetime,'forward',ekl_shipment_type) as shipment_direction_flag,
If(B.ekl_shipment_type like '%rto%' and B.rto_create_datetime > A.outgoing_consignment_create_datetime,'forward',ekl_shipment_type) as shipment_direction_flag_out
from 
(
select 
vendor_tracking_id,
incoming_consignment_id,
incoming_bag_id,
incoming_consignment_system_weight,
incoming_consignment_connection_id,
incoming_consignment_type,
incoming_consignment_mode,
incoming_connection_type,
incoming_connection_transit_type,
incoming_connection_code,
incoming_connection_frequency_type,
incoming_consignment_status,
incoming_consignment_co_loader,
incoming_consignment_breach_flag,
incoming_consignment_movement_flag,
incoming_consignment_no_of_bags,
incoming_consignment_no_of_shipments,
incoming_consignment_tms_compliant_flag,
incoming_consignment_creation_delay_in_hours,
incoming_consignment_source_hub_type,
incoming_consignment_destination_hub_type,
incoming_consignment_source_hub_id ,
incoming_consignment_destination_hub_id,
incoming_consignment_source_hub_id_key,
incoming_consignment_destination_hub_id_key,
incoming_connection_cut_off_datetime,
incoming_consignment_create_datetime,
incoming_consignment_create_unixseconds,
incoming_consignment_status_date_time,
incoming_consignment_eta_datetime,
incoming_consignment_received_datetime,
incoming_bag_tracking_id,
incoming_bag_service_type,
incoming_bag_seal_id,
incoming_bag_current_status,
incoming_bag_category,
incoming_bag_no_of_shipments,
incoming_bag_eta_update_reason,
incoming_bag_system_weight,
incoming_bag_source_hub_id,
incoming_bag_current_hub_id,
incoming_bag_destination_hub_id,
incoming_bag_source_hub_id_key,
incoming_bag_current_hub_id_key,
incoming_bag_destination_hub_id_key,
incoming_bag_created_hub_type,
incoming_bag_current_hub_type,
incoming_bag_destination_hub_type,
incoming_bag_created_at_datetime,
incoming_bag_open_datetime,
incoming_bag_closed_datetime,
incoming_bag_connected_datetime,
incoming_bag_destination_hub_inscan_datetime,
incoming_bag_receive_datetime,
incoming_bag_last_update_datetime,
incoming_hop_source_type,
outgoing_consignment_id,
outgoing_bag_id,
outgoing_consignment_system_weight,
outgoing_consignment_connection_id,
outgoing_consignment_type,
outgoing_consignment_mode,
outgoing_connection_type,
outgoing_connection_transit_type,
outgoing_connection_code,
outgoing_connection_frequency_type,
outgoing_consignment_status,
outgoing_consignment_co_loader,
outgoing_consignment_breach_flag,
outgoing_consignment_movement_flag,
outgoing_consignment_no_of_bags,
outgoing_consignment_no_of_shipments,
outgoing_consignment_tms_compliant_flag,
outgoing_consignment_creation_delay_in_hours,
outgoing_consignment_source_hub_type,
outgoing_consignment_destination_hub_type,
outgoing_consignment_source_hub_id ,
outgoing_consignment_destination_hub_id, 
outgoing_consignment_source_hub_id_key,
outgoing_consignment_destination_hub_id_key,
outgoing_connection_cut_off_datetime,
outgoing_consignment_create_datetime,
outgoing_consignment_create_unixseconds,
outgoing_consignment_status_date_time,
outgoing_consignment_eta_datetime,
outgoing_consignment_received_datetime,
outgoing_bag_tracking_id,
outgoing_bag_service_type,
outgoing_bag_seal_id,
outgoing_bag_current_status,
outgoing_bag_category,
outgoing_bag_no_of_shipments,
outgoing_bag_eta_update_reason,
outgoing_bag_system_weight,
outgoing_bag_source_hub_id,
outgoing_bag_current_hub_id,
outgoing_bag_destination_hub_id,
outgoing_bag_source_hub_id_key,
outgoing_bag_current_hub_id_key,
outgoing_bag_destination_hub_id_key,
outgoing_bag_created_hub_type,
outgoing_bag_current_hub_type,
outgoing_bag_destination_hub_type,
outgoing_bag_created_at_datetime,
outgoing_bag_open_datetime,
outgoing_bag_closed_datetime,
outgoing_bag_connected_datetime,
outgoing_bag_destination_hub_inscan_datetime,
outgoing_bag_receive_datetime,
outgoing_bag_last_update_datetime,
outgoing_hop_source_type
from 
bigfoot_external_neo.scp_ekl__shipment_facility_l1_90_fact) A 
left join 
bigfoot_external_neo.scp_ekl__shipment_l1_90_fact B 
on A.vendor_tracking_id = B.vendor_tracking_id
left join 
(
select 
vendor_tracking_id,
incoming_consignment_id,
incoming_bag_id,
incoming_consignment_system_weight,
incoming_consignment_connection_id,
incoming_consignment_type,
incoming_consignment_mode,
incoming_connection_type,
incoming_connection_transit_type,
incoming_connection_code,
incoming_connection_frequency_type,
incoming_consignment_status,
incoming_consignment_co_loader,
incoming_consignment_breach_flag,
incoming_consignment_movement_flag,
incoming_consignment_no_of_bags,
incoming_consignment_no_of_shipments,
incoming_consignment_tms_compliant_flag,
incoming_consignment_creation_delay_in_hours,
incoming_consignment_source_hub_type,
incoming_consignment_destination_hub_type,
incoming_consignment_source_hub_id ,
incoming_consignment_destination_hub_id,
incoming_consignment_source_hub_id_key,
incoming_consignment_destination_hub_id_key,
incoming_connection_cut_off_datetime,
incoming_consignment_create_datetime,
incoming_consignment_create_unixseconds,
incoming_consignment_status_date_time,
incoming_consignment_eta_datetime,
incoming_consignment_received_datetime,
incoming_bag_tracking_id,
incoming_bag_service_type,
incoming_bag_seal_id,
incoming_bag_current_status,
incoming_bag_category,
incoming_bag_no_of_shipments,
incoming_bag_eta_update_reason,
incoming_bag_system_weight,
incoming_bag_source_hub_id,
incoming_bag_current_hub_id,
incoming_bag_destination_hub_id,
incoming_bag_source_hub_id_key,
incoming_bag_current_hub_id_key,
incoming_bag_destination_hub_id_key,
incoming_bag_created_hub_type,
incoming_bag_current_hub_type,
incoming_bag_destination_hub_type,
incoming_bag_created_at_datetime,
incoming_bag_open_datetime,
incoming_bag_closed_datetime,
incoming_bag_connected_datetime,
incoming_bag_destination_hub_inscan_datetime,
incoming_bag_receive_datetime,
incoming_bag_last_update_datetime,
incoming_hop_source_type,
outgoing_consignment_id,
outgoing_bag_id,
outgoing_consignment_system_weight,
outgoing_consignment_connection_id,
outgoing_consignment_type,
outgoing_consignment_mode,
outgoing_connection_type,
outgoing_connection_transit_type,
outgoing_connection_code,
outgoing_connection_frequency_type,
outgoing_consignment_status,
outgoing_consignment_co_loader,
outgoing_consignment_breach_flag,
outgoing_consignment_movement_flag,
outgoing_consignment_no_of_bags,
outgoing_consignment_no_of_shipments,
outgoing_consignment_tms_compliant_flag,
outgoing_consignment_creation_delay_in_hours,
outgoing_consignment_source_hub_type,
outgoing_consignment_destination_hub_type,
outgoing_consignment_source_hub_id ,
outgoing_consignment_destination_hub_id, 
outgoing_consignment_source_hub_id_key,
outgoing_consignment_destination_hub_id_key,
outgoing_connection_cut_off_datetime,
outgoing_consignment_create_datetime,
outgoing_consignment_create_unixseconds,
outgoing_consignment_status_date_time,
outgoing_consignment_eta_datetime,
outgoing_consignment_received_datetime,
outgoing_bag_tracking_id,
outgoing_bag_service_type,
outgoing_bag_seal_id,
outgoing_bag_current_status,
outgoing_bag_category,
outgoing_bag_no_of_shipments,
outgoing_bag_eta_update_reason,
outgoing_bag_system_weight,
outgoing_bag_source_hub_id,
outgoing_bag_current_hub_id,
outgoing_bag_destination_hub_id,
outgoing_bag_source_hub_id_key,
outgoing_bag_current_hub_id_key,
outgoing_bag_destination_hub_id_key,
outgoing_bag_created_hub_type,
outgoing_bag_current_hub_type,
outgoing_bag_destination_hub_type,
outgoing_bag_created_at_datetime,
outgoing_bag_open_datetime,
outgoing_bag_closed_datetime,
outgoing_bag_connected_datetime,
outgoing_bag_destination_hub_inscan_datetime,
outgoing_bag_receive_datetime,
outgoing_bag_last_update_datetime,
outgoing_hop_source_type
from 
bigfoot_external_neo.scp_ekl__shipment_facility_l1_90_fact
) T
on 
A.vendor_tracking_id = T.vendor_tracking_id
and 
A.incoming_consignment_id = T.outgoing_consignment_id 
) D
left join 
(select `data`.vendor_tracking_id as vendor_tracking_id,`data`.shipment_type,`data`.current_address.id as current_address, min(updatedat) as shipment_inscan, max(updatedat) as shipment_inscan_2 from bigfoot_journal.dart_wsr_scp_ekl_shipment_4
where  day  > date_format(date_sub(current_date,90),'yyyyMMdd') and 
`data`.status = 'Received'  
group by `data`.vendor_tracking_id,`data`.current_address.id,`data`.shipment_type) C on D.vendor_tracking_id = C.vendor_tracking_id and D.incoming_consignment_source_hub_id = C.current_address and 
D.shipment_direction_flag = C.shipment_type
left join 
(select `data`.vendor_tracking_id as vendor_tracking_id,`data`.shipment_type,`data`.current_address.id as current_address, min(updatedat) as shipment_inscan,max(updatedat) as shipment_inscan_2 from bigfoot_journal.dart_wsr_scp_ekl_shipment_4
where  day  > date_format(date_sub(current_date,90),'yyyyMMdd') and 
`data`.status = 'Received'  
group by `data`.vendor_tracking_id,`data`.current_address.id,`data`.shipment_type) E on D.vendor_tracking_id = E.vendor_tracking_id and D.outgoing_consignment_source_hub_id = E.current_address and 
D.shipment_direction_flag_out = E.shipment_type
LEFT JOIN bigfoot_external_neo.scp_ekl__bag_l1_total_fact as sr
on sr.vendor_tracking_id=D.vendor_tracking_id and sr.bag_id =D.incoming_bag_id
;